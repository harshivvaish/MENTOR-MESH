<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro-Internship Interview</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #a855f7;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --error-color: #ef4444;
            --success-color: #22c55e;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-primary); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 900px; background-color: var(--bg-card); border-radius: 12px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { margin-bottom: 0.5rem; }
        .instructions { color: var(--text-secondary); margin-bottom: 2rem; }
        .interview-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; }
        .questions-panel { border-right: 1px solid var(--border-color); padding-right: 2rem; }
        .questions-panel h2 { font-size: 1.2rem; margin-bottom: 1rem; }
        .questions-panel ul { list-style: none; padding-left: 0; }
        .questions-panel li { margin-bottom: 1rem; color: var(--text-secondary); }
        .video-panel { display: flex; flex-direction: column; align-items: center; }
        video { width: 100%; border-radius: 8px; background-color: #000; margin-bottom: 1rem; transform: scaleX(-1); } /* Mirror effect */
        #playback { transform: scaleX(1); }
        #timer { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--primary-color); }
        .controls { display: flex; gap: 1rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: .5rem; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all .3s ease; border: none; cursor: pointer; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-danger { background-color: var(--error-color); color: #fff; }
        .btn:disabled { background-color: var(--border-color); cursor: not-allowed; }
        #status { margin-top: 1rem; font-weight: 500; height: 20px; }
        .success { color: var(--success-color); }
        .error { color: var(--error-color); }
        @media (max-width: 768px) { .interview-layout { grid-template-columns: 1fr; } .questions-panel { border-right: none; border-bottom: 1px solid var(--border-color); padding-right: 0; padding-bottom: 2rem; margin-bottom: 2rem; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Interview</h1>
        <p class="instructions">You have <strong>5 minutes</strong> to answer the following questions. The recording will start when you click the button and will stop automatically.</p>
        
        <div class="interview-layout">
            <div class="questions-panel">
                <h2>Questions</h2>
                <ul>
                    {% for q in questions %}
                        <li>{{ loop.index }}. {{ q }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="video-panel">
                <div id="timer">5:00</div>
                <video id="live-preview" width="480" autoplay muted></video>
                <video id="playback" width="480" controls style="display:none;"></video>
                <div class="controls">
                    <button id="startButton" class="btn btn-primary"><i class="fas fa-video"></i> Start Recording</button>
                    <button id="stopButton" class="btn btn-danger" disabled><i class="fas fa-stop"></i> Stop</button>
                    <button id="submitButton" class="btn" disabled><i class="fas fa-upload"></i> Submit Video</button>
                </div>
                <div id="status"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const submitButton = document.getElementById('submitButton');
            const livePreview = document.getElementById('live-preview');
            const playback = document.getElementById('playback');
            const timerDisplay = document.getElementById('timer');
            const statusDisplay = document.getElementById('status');

            let mediaRecorder;
            let recordedChunks = [];
            let timerInterval;
            let videoBlob;

            startButton.addEventListener('click', async () => {
                statusDisplay.textContent = '';
                recordedChunks = [];
                livePreview.style.display = 'block';
                playback.style.display = 'none';
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    livePreview.srcObject = stream;
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) recordedChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                        playback.src = URL.createObjectURL(videoBlob);
                        
                        livePreview.style.display = 'none';
                        playback.style.display = 'block';
                        submitButton.disabled = false;
                        submitButton.classList.add('btn-primary');
                        startButton.disabled = false;
                        startButton.textContent = "Record Again";
                        stopButton.disabled = true;
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    startTimer(300); // 5 minutes in seconds
                    
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    submitButton.disabled = true;
                    submitButton.classList.remove('btn-primary');
                    statusDisplay.textContent = 'Recording...';
                } catch (err) {
                    statusDisplay.textContent = 'Error: Could not access camera/mic. Please grant permission.';
                    statusDisplay.classList.add('error');
                    console.error("Error accessing media devices.", err);
                }
            });

            stopButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                clearInterval(timerInterval);
            });
            
            function startTimer(duration) {
                let timer = duration;
                timerDisplay.textContent = "5:00";
                timerInterval = setInterval(() => {
                    let minutes = parseInt(timer / 60, 10);
                    let seconds = parseInt(timer % 60, 10);
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;
                    timerDisplay.textContent = minutes + ":" + seconds;
                    
                    if (--timer < 0) {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }
            
            submitButton.addEventListener('click', () => {
                if (!videoBlob) {
                    alert("No video recorded to submit.");
                    return;
                }
                
                statusDisplay.textContent = 'Uploading... Please wait.';
                statusDisplay.classList.remove('error', 'success');
                submitButton.disabled = true;

                const formData = new FormData();
                formData.append('video_submission', videoBlob, 'interview.webm');
                
                fetch('/upload-video', { method: 'POST', body: formData })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        statusDisplay.textContent = 'Upload successful!';
                        statusDisplay.classList.add('success');
                        console.log('Success:', data);
                    })
                    .catch(error => {
                        statusDisplay.textContent = 'Upload failed. Please try again.';
                        statusDisplay.classList.add('error');
                        submitButton.disabled = false;
                        console.error('Error:', error);
                    });
            });
        });
    </script>
</body>
</html>